# OpenAPI Specification Best Practices & Improvements Guide

## Context
We created, reviewed, and then significantly improved `perception.json` (OpenAPI 3.1.0 spec for Image Analysis API v2.0) following REST and JSON:API best practices. This is the next version of Services API, written after fully isolating MCAP services from Calipsa services. The Image Analysis API (v2.x stream) is intended to supercede and ultimately replace `index.json` (v1.x stream).

## Procedure
The team manually copied and pasted from the existing `index.json` and related schemas to create a new file called `perception.json`. While doing so, we removed outdated concepts and structures and carefully considering what target state should look like.

Then the team asked Claude to inspect the API definition and come up with suggestions for improvement. This document, which summarizes the changes that were made, was (mostly) generated by Claude at the end of the session. The work was done using Claude Sonnet 4.5 and Cursor the week of October 13, 2025.

## Key Improvements Made

### **Description Consistency** *(Added October 16, 2025)*
- Standardized all 400 error descriptions to use generic format: "Bad Request - The request does not conform to the expected schema or contains invalid parameters"
- Standardized 404 error description to follow "Returned when..." pattern: "Returned when the requested resource was not found."
- Added missing `security` specification to `/analyses` GET endpoint (requires `CompanyToken`)
- Maintained shorter format for analyzer endpoint 200 responses for better readability

### **Security & Authentication**
- Added explicit `security` requirements to all endpoints that were missing them
- Use `CompanyToken` (JWT bearer) for company-level operations
- Use `IntegrationPartnerToken` for partner-level tenant management
- All error response schemas are complete with proper structure

### **Schema Organization & Documentation**
- **Reference Strategy**: Internal refs (`#/components/schemas/...`) for generic HTTP errors; external refs (`./schemas/...`) for domain objects
- Documented this strategy in the API description for maintainability
- All error schemas (400, 401, 403, 404, 500, 503) have complete `type`, `required`, and `properties` definitions

### **Content Type Consistency**
- **All responses** use `application/vnd.api+json` (JSON:API 1.1)
- Request bodies use `application/json` or `multipart/form-data` as appropriate
- No mixing of content types in responses

### **Request Validation**
- Required fields explicitly marked in `multipart/form-data` schemas
- Pagination parameters documented with behavior (no default page size = returns all records)
- Analysis options use `additionalProperties: false` for forward compatibility

### **Analytics Options Pattern**
- **Full-frame analysis** (`FullFrameAnalysisOptions.json`): Multiple analytics can be enabled simultaneously (feature selection)
- **Chip analysis** (`ChipAnalysisOptions.json`): Uses `oneOf` constraint to require exactly one analysis type (person, vehicle, lpr, face, gun)
- All feature selection objects have `additionalProperties: false` (can be removed later without breaking changes)
- Clear descriptions: "Include [analysis type] in the response"

### **Documentation Quality**
- All operations have both `summary` and `description` fields
- Descriptions explain what, when, and why for each endpoint
- Examples provided for common use cases
- No empty `examples: {}` or `examples: []` objects

### **Error Handling**
- Comprehensive error responses: 400, 401, 403, 404, 500, 503
- 400 Bad Request for schema validation errors and invalid parameters
- No 413 (not needed) or 429 (no rate limiting for this service)
- Error schemas follow consistent structure with JSON:API 1.1 format

### **Best Practices Applied**
- ✅ API versioning **not** in path (considered antipattern - version in content negotiation instead)
- ✅ Backward compatibility maintained (no breaking changes)
- ✅ Forward compatibility enabled (`additionalProperties: false` can be removed when adding optional config)
- ✅ Team contact email instead of personal
- ✅ Proper camelCase naming (fixed `viewintegratorId` → `viewIntegratorId`)
- ✅ Pagination: cursor-based with no maximum page size for backward compatibility

## File Structure
```
openapi/
├── perception.json (main spec)
└── schemas/
    ├── v2/
    │   ├── FullFrameAnalysisOptions.json (multi-select analytics)
    │   ├── ChipAnalysisOptions.json (oneOf constraint)
    │   └── AnalysisContext.json
    ├── [domain objects: Company, AlarmAnalysis, etc.]
    └── jsonapi/ (JSON:API standard schemas)
```

## Key Patterns to Maintain

### Feature Selection (Request-Only)
```json
{
  "type": "object",
  "additionalProperties": false,
  "description": "Include [feature] in the response."
}
```

### Mutually Exclusive Options (oneOf)
```json
{
  "type": "object",
  "oneOf": [
    {
      "required": ["option1"],
      "additionalProperties": false,
      "properties": {
        "option1": { "type": "object", "additionalProperties": false }
      }
    }
  ]
}
```

### Error Schemas
```json
{
  "type": "object",
  "required": ["errors"],
  "properties": {
    "errors": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["status", "detail"],
        "properties": {
          "status": { "type": "string", "example": "400" },
          "detail": { "type": "string" }
        }
      }
    }
  }
}
```

## Commands for Future Reference
- Validate spec: Check for linter errors after changes
- Search for empty examples: `"examples":\s*\{\}` or `"examples":\s*\[\s*\]`
- Find missing security: Look for operations without `security` field

## Decisions & Rationale
1. **No rate limiting (429)**: Internal API with pre-negotiated usage
2. **No payload size limit (413)**: Removed (as this rarely happens and we will use response code 400 for this)
3. **No max page size**: Backward compatibility with clients expecting all records
4. **additionalProperties: false on feature selection**: Non-breaking to remove later when adding config options
5. **Generic 400 error descriptions**: Prioritized consistency over endpoint-specific context for better maintainability
6. **Shorter analyzer response descriptions**: Kept "A successful [type] analysis result" format for readability vs. verbose "Returned when..." pattern

This guide captures our improvements and can serve as a reference for maintaining consistency across API versions or when onboarding new team members.

